# План разработки Terraform провайдера для управления выделенными серверами Selectel

## Обзор проекта

### Цель
Разработать terraform провайдер для управления выделенными серверами (bare metal) Selectel, который будет интегрироваться с существующим провайдером Selectel и предоставлять полный функционал для управления физическими серверами через Infrastructure as Code.

### Базовая информация
- **Название проекта**: terraform-provider-selectel-baremetal
- **Язык разработки**: Go 1.23+
- **Terraform версия**: 1.0+
- **Лицензия**: MPL-2.0 (совместимо с существующим провайдером)
- **API версия**: Dedicated Servers API v2

## Анализ существующей экосистемы

### Существующий провайдер Selectel
Текущий провайдер Selectel (https://github.com/selectel/terraform-provider-selectel) поддерживает:
- Cloud серверы (OpenStack)
- Сетевые ресурсы
- Managed Kubernetes
- Container Registry
- Managed Databases
- DNS Hosting
- Object Storage
- IAM (пользователи и роли)

**НО НЕ ПОДДЕРЖИВАЕТ**: Выделенные серверы (bare metal)

### API Selectel для выделенных серверов
Базовый URL: `https://api.selectel.ru/dedicated/v2/`

Основные эндпоинты:
- `/dashboard/` - информация о статусе API
- `/location/` - локации и дата-центры
- `/service/` - каталог услуг и конфигураций серверов
- `/resource/` - управление ресурсами (серверами)
- `/power/` - управление питанием серверов
- `/boot/` - управление загрузкой и ОС
- `/network/` - управление сетевыми настройками
- `/events/` - события и логи
- `/tasks/` - задачи и их статус

## Архитектура решения

### Структура проекта
```
terraform-provider-selectel-baremetal/
├── cmd/
│   └── terraform-provider-selectel-baremetal/
│       └── main.go                    # Точка входа провайдера
├── internal/
│   ├── provider/
│   │   ├── provider.go               # Основной провайдер
│   │   ├── config.go                 # Конфигурация провайдера
│   │   └── auth.go                   # Аутентификация
│   ├── resources/
│   │   ├── dedicated_server.go       # Ресурс выделенного сервера
│   │   ├── server_network.go         # Сетевые настройки сервера
│   │   ├── server_os.go              # Управление ОС сервера
│   │   └── server_power.go           # Управление питанием
│   ├── datasources/
│   │   ├── locations.go              # Источник данных локаций
│   │   ├── services.go               # Источник данных услуг
│   │   ├── os_templates.go           # Источник данных шаблонов ОС
│   │   └── price_plans.go            # Источник данных тарифных планов
│   ├── client/
│   │   ├── client.go                 # HTTP клиент для API
│   │   ├── auth.go                   # Методы аутентификации
│   │   ├── servers.go                # API методы для серверов
│   │   ├── locations.go              # API методы для локаций
│   │   ├── services.go               # API методы для услуг
│   │   ├── power.go                  # API методы управления питанием
│   │   ├── boot.go                   # API методы управления загрузкой
│   │   └── network.go                # API методы сетевых настроек
│   ├── models/
│   │   ├── server.go                 # Модели данных сервера
│   │   ├── location.go               # Модели данных локаций
│   │   ├── service.go                # Модели данных услуг
│   │   ├── network.go                # Модели сетевых данных
│   │   └── common.go                 # Общие модели
│   └── utils/
│       ├── retry.go                  # Утилиты повторных попыток
│       ├── validation.go             # Валидация данных
│       └── helpers.go                # Вспомогательные функции
├── pkg/
│   └── selectel/
│       └── api/                      # Публичные API интерфейсы
├── test/
│   ├── acceptance/                   # Acceptance тесты
│   ├── unit/                         # Unit тесты
│   └── fixtures/                     # Тестовые данные
├── examples/
│   ├── basic-server/                 # Базовый пример сервера
│   ├── custom-server/                # Кастомный сервер
│   ├── multiple-servers/             # Несколько серверов
│   └── with-networking/              # Сервер с сетевыми настройками
├── docs/
│   ├── resources/                    # Документация ресурсов
│   ├── data-sources/                 # Документация источников данных
│   └── guides/                       # Руководства пользователя
├── scripts/
│   ├── build.sh                      # Скрипт сборки
│   ├── test.sh                       # Скрипт тестирования
│   └── release.sh                    # Скрипт релиза
├── .github/
│   └── workflows/                    # GitHub Actions
├── go.mod
├── go.sum
├── Makefile
├── README.md
├── CHANGELOG.md
├── LICENSE
└── .goreleaser.yml
```

### Основные компоненты

#### 1. Provider Configuration
```hcl
terraform {
  required_providers {
    selectel-baremetal = {
      source  = "selectel/selectel-baremetal"
      version = "~> 1.0"
    }
  }
}

provider "selectel-baremetal" {
  token      = var.selectel_token
  project_id = var.project_id
  endpoint   = "https://api.selectel.ru/dedicated/v2"
}
```

#### 2. Основные ресурсы для реализации

##### A. `selectel_baremetal_server` - Основной ресурс сервера
```hcl
resource "selectel_baremetal_server" "example" {
  name               = "my-server"
  service_uuid       = data.selectel_baremetal_service.server.uuid
  location_uuid      = data.selectel_baremetal_location.msk.uuid
  price_plan_uuid    = data.selectel_baremetal_price_plan.monthly.uuid
  project_uuid       = var.project_id
  
  # Сетевые настройки
  network {
    type = "public"
    bandwidth = 1000
  }
  
  # Настройки ОС
  os {
    template_uuid = data.selectel_baremetal_os_template.ubuntu.uuid
    password      = var.root_password
    ssh_keys      = [var.ssh_key]
  }
  
  # Дополнительные ресурсы
  additional_services = [
    data.selectel_baremetal_service.backup.uuid
  ]
  
  tags = {
    Environment = "production"
    Team        = "infrastructure"
  }
}
```

##### B. `selectel_baremetal_server_network` - Сетевые настройки
```hcl
resource "selectel_baremetal_server_network" "example" {
  server_uuid = selectel_baremetal_server.example.uuid
  
  network {
    type      = "private"
    subnet    = "192.168.1.0/24"
    vlan_id   = 100
  }
  
  firewall_rules {
    protocol = "tcp"
    port     = 22
    source   = "0.0.0.0/0"
    action   = "allow"
  }
}
```

##### C. `selectel_baremetal_server_power` - Управление питанием
```hcl
resource "selectel_baremetal_server_power" "example" {
  server_uuid = selectel_baremetal_server.example.uuid
  state       = "on"  # on, off, reboot
  
  # Автоматическое включение после создания
  auto_power_on = true
}
```

#### 3. Data Sources (Источники данных)

##### A. `selectel_baremetal_locations` - Локации
```hcl
data "selectel_baremetal_locations" "all" {}

data "selectel_baremetal_location" "msk" {
  name = "Moscow"
}
```

##### B. `selectel_baremetal_services` - Каталог услуг
```hcl
data "selectel_baremetal_services" "servers" {
  model = "server"
}

data "selectel_baremetal_service" "server" {
  name = "Intel Xeon E-2288G"
}
```

##### C. `selectel_baremetal_os_templates` - Шаблоны ОС
```hcl
data "selectel_baremetal_os_templates" "all" {}

data "selectel_baremetal_os_template" "ubuntu" {
  name = "Ubuntu 22.04 LTS"
}
```

##### D. `selectel_baremetal_price_plans` - Тарифные планы
```hcl
data "selectel_baremetal_price_plans" "all" {
  service_uuid = data.selectel_baremetal_service.server.uuid
}
```

## Детальный план реализации

### Этап 1: Подготовка и настройка проекта (1-2 дня)

#### 1.1 Инициализация проекта
- [ ] Создание структуры каталогов
- [ ] Настройка Go modules (`go.mod`, `go.sum`)
- [ ] Настройка Makefile для автоматизации задач
- [ ] Настройка линтеров (golangci-lint)
- [ ] Настройка GitHub Actions для CI/CD
- [ ] Создание базового README.md

#### 1.2 Настройка зависимостей
```go
// Основные зависимости
require (
    github.com/hashicorp/terraform-plugin-sdk/v2 v2.29.0
    github.com/hashicorp/terraform-plugin-framework v1.4.2
    github.com/hashicorp/terraform-plugin-log v0.9.0
    github.com/hashicorp/terraform-plugin-testing v1.5.1
)
```

### Этап 2: Разработка HTTP клиента для API (2-3 дня)

#### 2.1 Базовый HTTP клиент
- [ ] Структура клиента с аутентификацией
- [ ] Обработка ошибок и retry логика
- [ ] Логирование запросов и ответов
- [ ] Поддержка контекстов для таймаутов

#### 2.2 API методы
- [ ] Аутентификация (IAM токены)
- [ ] Методы для работы с локациями
- [ ] Методы для работы с каталогом услуг
- [ ] Методы для управления серверами
- [ ] Методы для управления питанием
- [ ] Методы для управления ОС и загрузкой
- [ ] Методы для сетевых настроек

#### 2.3 Модели данных
- [ ] Структуры для всех API ответов
- [ ] Валидация входных данных
- [ ] Маппинг между API и Terraform схемами

### Этап 3: Разработка провайдера (2-3 дня)

#### 3.1 Основной провайдер
- [ ] Конфигурация провайдера
- [ ] Схема аутентификации
- [ ] Инициализация клиента
- [ ] Валидация конфигурации

#### 3.2 Утилиты и хелперы
- [ ] Функции retry с экспоненциальным backoff
- [ ] Валидаторы для UUID, IP адресов, портов
- [ ] Хелперы для работы с состоянием Terraform
- [ ] Функции для обработки асинхронных операций

### Этап 4: Разработка Data Sources (2-3 дня)

#### 4.1 Источники данных локаций
- [ ] `selectel_baremetal_locations` - список всех локаций
- [ ] `selectel_baremetal_location` - конкретная локация
- [ ] Кэширование данных локаций

#### 4.2 Источники данных услуг
- [ ] `selectel_baremetal_services` - каталог услуг
- [ ] `selectel_baremetal_service` - конкретная услуга
- [ ] Фильтрация по типу услуги (server, colocation, etc.)

#### 4.3 Источники данных ОС
- [ ] `selectel_baremetal_os_templates` - шаблоны ОС
- [ ] `selectel_baremetal_os_template` - конкретный шаблон
- [ ] Фильтрация по типу ОС

#### 4.4 Источники данных тарифов
- [ ] `selectel_baremetal_price_plans` - тарифные планы
- [ ] Фильтрация по услуге и локации

### Этап 5: Разработка основного ресурса сервера (3-4 дня)

#### 5.1 Схема ресурса
- [ ] Определение всех атрибутов сервера
- [ ] Валидация входных параметров
- [ ] Computed поля для автоматически заполняемых значений

#### 5.2 CRUD операции
- [ ] **Create**: Заказ и активация сервера
  - Валидация параметров заказа
  - Отправка запроса на создание
  - Ожидание активации (polling)
  - Сохранение состояния
- [ ] **Read**: Получение текущего состояния сервера
  - Получение информации о сервере
  - Обновление computed полей
  - Обработка случаев когда сервер не найден
- [ ] **Update**: Обновление конфигурации сервера
  - Определение изменяемых параметров
  - Апгрейд/даунгрейд ресурсов
  - Изменение тегов и метаданных
- [ ] **Delete**: Удаление сервера
  - Остановка сервера
  - Отмена услуги
  - Очистка состояния

#### 5.3 Обработка асинхронных операций
- [ ] Polling статуса задач
- [ ] Таймауты для длительных операций
- [ ] Обработка ошибок и откатов

### Этап 6: Разработка дополнительных ресурсов (2-3 дня)

#### 6.1 Управление питанием
- [ ] `selectel_baremetal_server_power`
- [ ] Операции: включение, выключение, перезагрузка
- [ ] Мониторинг состояния питания

#### 6.2 Сетевые настройки
- [ ] `selectel_baremetal_server_network`
- [ ] Настройка публичных и приватных сетей
- [ ] Управление VLAN
- [ ] Базовые правила файрвола

#### 6.3 Управление ОС
- [ ] `selectel_baremetal_server_os`
- [ ] Установка и переустановка ОС
- [ ] Управление SSH ключами
- [ ] Настройка паролей

### Этап 7: Тестирование (3-4 дня)

#### 7.1 Unit тесты
- [ ] Тесты для всех API методов
- [ ] Тесты для валидации данных
- [ ] Тесты для утилитарных функций
- [ ] Покрытие кода не менее 80%

#### 7.2 Integration тесты
- [ ] Тесты с mock API сервером
- [ ] Тесты схем ресурсов и data sources
- [ ] Тесты провайдера

#### 7.3 Acceptance тесты
- [ ] Тесты создания/удаления серверов
- [ ] Тесты обновления конфигурации
- [ ] Тесты управления питанием
- [ ] Тесты сетевых настроек
- [ ] Тесты с реальным API (опционально)

### Этап 8: Документация (2-3 дня)

#### 8.1 Документация ресурсов
- [ ] Описание всех ресурсов
- [ ] Примеры использования
- [ ] Описание всех атрибутов
- [ ] Описание импорта ресурсов

#### 8.2 Документация data sources
- [ ] Описание всех источников данных
- [ ] Примеры фильтрации
- [ ] Описание всех атрибутов

#### 8.3 Руководства пользователя
- [ ] Быстрый старт
- [ ] Примеры типовых сценариев
- [ ] Миграция с других провайдеров
- [ ] Troubleshooting

#### 8.4 Документация для разработчиков
- [ ] Архитектура провайдера
- [ ] Инструкции по сборке
- [ ] Инструкции по тестированию
- [ ] Инструкции по релизу

### Этап 9: Примеры и интеграция (1-2 дня)

#### 9.1 Примеры конфигураций
- [ ] Базовый сервер
- [ ] Сервер с кастомной конфигурацией
- [ ] Несколько серверов с балансировкой
- [ ] Интеграция с существующим провайдером Selectel

#### 9.2 Terraform модули
- [ ] Модуль для типового веб-сервера
- [ ] Модуль для кластера серверов
- [ ] Модуль для dev/staging/prod окружений

### Этап 10: Релиз и публикация (1-2 дня)

#### 10.1 Подготовка к релизу
- [ ] Финальное тестирование
- [ ] Обновление CHANGELOG.md
- [ ] Создание релизных тегов
- [ ] Подготовка релизных заметок

#### 10.2 Публикация
- [ ] Публикация в Terraform Registry
- [ ] Создание GitHub релиза
- [ ] Обновление документации
- [ ] Анонс в сообществе

## Технические требования

### Аутентификация
- Поддержка IAM токенов Selectel
- Поддержка переменных окружения
- Поддержка файлов конфигурации
- Автоматическое обновление токенов

### Обработка ошибок
- Детальные сообщения об ошибках
- Retry логика для временных сбоев
- Graceful handling недоступности API
- Валидация на стороне клиента

### Производительность
- Параллельные запросы где возможно
- Кэширование справочных данных
- Оптимизация polling операций
- Минимизация API вызовов

### Безопасность
- Безопасное хранение токенов
- Логирование без чувствительных данных
- Валидация всех входных данных
- Поддержка HTTPS only

## Интеграция с существующим провайдером

### Совместимость
- Использование тех же принципов именования
- Совместимость с существующими data sources (проекты, пользователи)
- Возможность использования в одной конфигурации

### Переиспользование кода
- Общие утилиты для работы с API
- Общие модели для проектов и пользователей
- Общие валидаторы

## Метрики успеха

### Функциональные метрики
- [ ] Поддержка всех основных операций с серверами
- [ ] Покрытие тестами не менее 80%
- [ ] Время создания сервера не более 15 минут
- [ ] Успешная интеграция с существующим провайдером

### Качественные метрики
- [ ] Понятная документация с примерами
- [ ] Простота использования для новых пользователей
- [ ] Соответствие best practices Terraform
- [ ] Положительные отзывы от пользователей

## Риски и митигация

### Технические риски
1. **Изменения в API Selectel**
   - Митигация: Версионирование API, обратная совместимость
2. **Сложность асинхронных операций**
   - Митигация: Тщательное тестирование, retry логика
3. **Производительность при большом количестве серверов**
   - Митигация: Оптимизация запросов, параллелизм

### Проектные риски
1. **Недостаток документации API**
   - Митигация: Тесное взаимодействие с командой Selectel
2. **Изменение требований**
   - Митигация: Итеративная разработка, регулярная обратная связь

## Заключение

Данный план предусматривает создание полнофункционального terraform провайдера для управления выделенными серверами Selectel. Провайдер будет соответствовать стандартам Terraform, обеспечивать надежную работу с API Selectel и предоставлять удобный интерфейс для управления инфраструктурой как кодом.

Общее время разработки: **20-25 рабочих дней** при работе одного разработчика.

При параллельной работе нескольких разработчиков время можно сократить до **10-15 рабочих дней**. 